
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>MEMET ÇINAR | A.I. SYSTEM v5.3 (Self-Hearing Fix)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght+900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Code Highlight -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-red: #ff0055;
            --hud-bg: rgba(10, 10, 15, 0.85);
            --hud-border: rgba(0, 243, 255, 0.3);
            --glass: rgba(20, 20, 30, 0.6);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #050508;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(0, 243, 255, 0.05) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(188, 19, 254, 0.05) 0%, transparent 25%);
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- HUD STYLES --- */
        .hud-panel {
            background: var(--hud-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--hud-border);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        /* Köşe Süsleri (Corner Accents) */
        .hud-corner {
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid var(--neon-blue);
            transition: all 0.3s ease;
        }
        .tl { top: 0; left: 0; border-right: none; border-bottom: none; }
        .tr { top: 0; right: 0; border-left: none; border-bottom: none; }
        .bl { bottom: 0; left: 0; border-right: none; border-top: none; }
        .br { bottom: 0; right: 0; border-left: none; border-top: none; }

        .hud-text { font-family: 'Share Tech Mono', monospace; letter-spacing: 1px; }
        .hud-title { font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 2px; }

        /* --- SCANLINE EFFECT --- */
        .scanline {
            position: fixed;
            top: 0; left: 0; w-full; h-full;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.3;
        }

        /* --- CHAT BUBBLES --- */
        .msg-bubble {
            max-width: 85%;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            font-size: 1.1rem;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-user {
            background: linear-gradient(135deg, rgba(0, 243, 255, 0.1), rgba(0, 243, 255, 0.2));
            border-left: 3px solid var(--neon-blue);
            color: #fff;
            margin-left: auto;
            text-align: right;
        }

        .msg-ai {
            background: linear-gradient(135deg, rgba(188, 19, 254, 0.1), rgba(188, 19, 254, 0.05));
            border-right: 3px solid var(--neon-purple);
            color: #d1d5db;
            margin-right: auto;
        }

        /* --- WIDGETS --- */
        .widget-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* --- ANIMATIONS --- */
        .listening-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 2px solid var(--neon-red);
            opacity: 0;
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { width: 50px; height: 50px; opacity: 1; border-width: 5px; }
            100% { width: 200px; height: 200px; opacity: 0; border-width: 0px; }
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050508; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid #444; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        /* --- NOTIFICATION --- */
        #notification-area {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .notify-toast {
            background: rgba(10, 20, 30, 0.95);
            border: 1px solid var(--neon-blue);
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            animation: slideLeft 0.3s ease;
            max-width: 350px;
        }
        @keyframes slideLeft { from { transform: translateX(100%); } to { transform: translateX(0); } }

    </style>

    <!-- Firebase -->
    <script type="module">
        // Firebase importları burada kalsa da, bu örnekte kullanılmıyor. 
        // Ancak gereksinimlere uyum için bırakılmıştır.
        /*
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        */

        // --- CORE SYSTEM VARIABLES ---
        const API_KEY = "AIzaSyCb-RLlKexo_rYsswFUAyaiBlMPr4ZAIJw"; // System handled
        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";

        let recognition;
        let isSystemActive = false;
        let isWakeWordMode = false; 
        let isProcessing = false;
        let isRecognitionRunning = false;
        let isAiSpeaking = false; 
        let wakeWord = "patron"; 
        
        let audioContext;
        let notificationSound;

        // --- INIT ---
        window.addEventListener('load', async () => {
            // Firebase init kısmı (bu örnekte pasif)
            /*
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            await signInAnonymously(auth);
            */

            updateClock();
            setInterval(updateClock, 1000);
            
            // AudioContext başlatma
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("AudioContext başlatılamadı:", e);
                systemNotify("HATA", "Ses sistemi başlatılamadı.");
            }
        });

        // --- SYSTEM START & PERMISSIONS ---
        window.startSystem = async () => {
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
            
            if (audioContext && audioContext.state === 'suspended') await audioContext.resume();
            
            try {
                // Mikrofon izni kontrolü
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => t.stop()); 
                
                initSpeechRecognition();
                isSystemActive = true;
                isWakeWordMode = true; 
                
                systemNotify("SİSTEM ÇEVRİMİÇİ", "Hey Patron! Ben hazırım. Beni uyandırmak için 'Hey Patron' veya 'Memet' demen yeterli.");
                playSystemSound('startup');
                
                safeStartRecognition(); 
                
                updateStatus("UYKU MODU", "yellow");
                
            } catch (e) {
                console.error(e);
                systemNotify("HATA", "Mikrofon izni verilmedi. Sistem başlatılamadı.");
            }
        };

        // --- SPEECH RECOGNITION ENGINE ---
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                systemNotify("TARAYICI HATASI", "Tarayıcınız ses sistemini desteklemiyor.");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = true;
            recognition.lang = 'tr-TR';

            recognition.onstart = () => {
                isRecognitionRunning = true; 
                if(isWakeWordMode) {
                    updateStatus("DİNLİYOR (Uyku Modu)", "yellow");
                } else {
                    updateStatus("AKTİF DİNLEME", "red");
                    document.getElementById('listening-anim').style.opacity = '1';
                }
            };

            recognition.onresult = (event) => {
                // AI konuşuyorsa girişi tamamen yok say
                if (isAiSpeaking) return;

                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('')
                    .toLowerCase();

                if (isWakeWordMode) {
                    if (transcript.includes(wakeWord) || transcript.includes("hey " + wakeWord) || transcript.includes("memet")) {
                        activateCommandMode();
                    }
                } 
                else {
                    document.getElementById('user-input').value = transcript;
                    if (event.results[0].isFinal) {
                        handleSend(); 
                    }
                }
            };

            recognition.onend = () => {
                isRecognitionRunning = false; 
                document.getElementById('listening-anim').style.opacity = '0';

                // ** DÜZELTME: Konuşma bitince yeniden başlatmayı garantile **
                // AI konuşmuyorsa ve bir işlem yapmıyorsak, dinlemeyi yeniden başlat
                if (isSystemActive && !isAiSpeaking && !isProcessing) {
                    // Kısa bir gecikme ekleyerek InvalidStateError'ı önle
                    setTimeout(() => {
                        if (isWakeWordMode) {
                            updateStatus("UYKU MODU", "yellow");
                        }
                        safeStartRecognition();
                    }, 300); 
                }
                
                // Aktif komut modunda değilsek ve işlem bittiyse Uyku Moduna dön
                if(!isWakeWordMode && !isProcessing && !isAiSpeaking) {
                     isWakeWordMode = true;
                     updateStatus("UYKU MODU", "yellow");
                }
            };

            recognition.onerror = (event) => {
                console.warn("Speech error:", event.error);
                if (event.error === 'not-allowed') {
                    isSystemActive = false;
                    systemNotify("İZİN HATASI", "Mikrofon erişimi engellendi.");
                }
                // Hata durumunda da yeniden başlatmayı dene
                isRecognitionRunning = false;
                if(isSystemActive && !isAiSpeaking && !isProcessing) {
                     setTimeout(safeStartRecognition, 500);
                }
            };
        }

        function safeStartRecognition() {
            if (isRecognitionRunning || isAiSpeaking || isProcessing) return; 
            try {
                recognition.start();
            } catch (e) {
                // InvalidStateError'ı ignore et, çünkü genellikle zaten başlamıştır/başlamaya çalışıyordur
                if (e.name !== 'InvalidStateError') console.error("SafeStart Error:", e);
            }
        }

        function activateCommandMode() {
            isWakeWordMode = false;
            if(recognition) recognition.stop(); // Hali hazırda çalışıyorsa durdur
            playSystemSound('wake');
            updateStatus("KOMUT BEKLENİYOR", "red");
            
            setTimeout(() => {
                safeStartRecognition();
            }, 300); // Yeniden başlatmadan önce kısa bir gecikme
        }

        function updateStatus(text, colorClass) {
            const el = document.getElementById('system-status');
            el.innerText = text;
            el.className = `text-${colorClass}-400 hud-text font-bold`;
        }

        // --- AI LOGIC ---
        window.handleSend = async () => {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            isProcessing = true;
            if(recognition) recognition.stop();
            
            addMessage(text, 'user');
            input.value = '';

            const lower = text.toLowerCase();
            
            // Komutları işleme... (Örnek Komutlar)
            if (lower.includes('hava') && (lower.includes('durum') || lower.includes('nasıl'))) {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => { handleLocalCommand('weather', text, pos.coords); },
                        (err) => { handleLocalCommand('weather', text, null); }
                    );
                } else {
                     handleLocalCommand('weather', text, null);
                }
                return;
            }
            
            if (lower.includes('saat') || lower.includes('tarih') || lower.includes('yılbaşı') || lower.includes('kalan süre')) {
                handleLocalCommand('time', text);
                return;
            }

            if (lower.includes('maç') || lower.includes('skor') || lower.includes('lig')) {
                handleLocalCommand('sports', text);
                return;
            }

            if (lower.includes('dolar') || lower.includes('euro') || lower.includes('kur')) {
                handleLocalCommand('finance', text);
                return;
            }

            await processAI(text);
        };

        async function processAI(prompt) {
            showThinking(true);
            try {
                const systemPrompt = `Sen MEMET ÇINAR'sın. Fütüristik, zeki, esprili ve çok yetenekli bir yapay zekasın. Kullanıcıya 'Patron' diye hitap et. Cevapların kısa, net ve havalı olsun. HTML formatı kullanabilirsin.`;
                
                const response = await generateText(prompt, systemPrompt);
                
                showThinking(false);
                addMessage(response, 'ai');
                speak(response); 

            } catch (e) {
                console.error(e);
                showThinking(false);
                addMessage("Bağlantı hatası oluştu patron. Sistemleri kontrol et.", 'ai');
            } finally {
                isProcessing = false;
                // Yeniden başlatma artık playAudio/onended içinde yönetiliyor.
            }
        }

        async function handleLocalCommand(type, query, coords) {
            isProcessing = true;
            showThinking(true);
            
            let responseText = "";
            let widgetHTML = "";

            // ... (Local Command Logic - Hava durumu, saat vb.)
            if (type === 'weather') {
                const weatherPrompt = coords 
                    ? `Şu koordinatlardaki hava durumu: ${coords.latitude}, ${coords.longitude}. Detaylı bilgi ver.`
                    : `${query} için hava durumu bilgisi ver.`;
                
                const aiRes = await generateText(weatherPrompt, "Sen bir hava durumu sunucususun. Şu formatta cevap ver: Şehir Adı | Sıcaklık | Durum. Sonra kısa bir yorum yap.");
                responseText = aiRes;
                widgetHTML = `<div class="widget-card bg-yellow-900/10 border-yellow-500/30"><i class="fa-solid fa-cloud-sun fa-2x text-yellow-400"></i><div><div class="font-bold">Hava Durumu Raporu</div><div class="text-sm opacity-80">${new Date().toLocaleDateString()}</div></div></div>`;
            
            } else if (type === 'time') {
                const now = new Date();
                const newYear = new Date(now.getFullYear() + 1, 0, 1);
                const diff = newYear - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                responseText = `Şu an saat ${now.toLocaleTimeString()}. Yılbaşına ${days} gün kaldı Patron!`;
                widgetHTML = `
                <div class="widget-card bg-blue-900/10 border-blue-500/30">
                    <i class="fa-regular fa-clock fa-2x text-blue-400"></i>
                    <div>
                        <div class="text-2xl font-mono font-bold">${now.toLocaleTimeString()}</div>
                        <div class="text-xs text-blue-200">Yılbaşı Sayacı: ${days} Gün</div>
                    </div>
                </div>`;
            
            } else if (type === 'sports') {
                const aiRes = await generateText(query, "En güncel maç skorlarını listele. Süper lig öncelikli.");
                responseText = aiRes;
                widgetHTML = `<div class="widget-card bg-green-900/10 border-green-500/30"><i class="fa-solid fa-futbol fa-2x text-green-400"></i><div><div class="font-bold">Canlı Skor Merkezi</div><div class="text-xs">Veriler güncelleniyor...</div></div></div>`;
            
            } else if (type === 'finance') {
                const aiRes = await generateText(query, "Güncel dolar ve euro kurlarını söyle.");
                responseText = aiRes;
                widgetHTML = `<div class="widget-card bg-emerald-900/10 border-emerald-500/30"><i class="fa-solid fa-money-bill-trend-up fa-2x text-emerald-400"></i><div><div class="font-bold">Piyasa Verileri</div><div class="text-xs">BIST/FOREX</div></div></div>`;
            }

            showThinking(false);
            addMessage(responseText + widgetHTML, 'ai');
            speak(responseText);
            
            isProcessing = false;
        }

        // --- MUSIC MAKER ---
        // (Music Maker Fonksiyonları burada kalır)
        window.openMusicMaker = () => { document.getElementById('music-modal').style.display = 'flex'; };
        window.closeMusicMaker = () => { document.getElementById('music-modal').style.display = 'none'; };

        window.generateMusic = async () => {
            const style = document.getElementById('music-style').value;
            const topic = document.getElementById('music-topic').value;
            const gender = document.getElementById('music-gender').value;

            if(!style || !topic) return systemNotify("GEREKLİ BİLGİ", "Lütfen stil ve konu girin.");

            const btn = document.getElementById('btn-generate-music');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Besteleniyor...';
            btn.disabled = true;

            const prompt = `Şarkı yap. Stil: ${style}, Konu: ${topic}, Vokal: ${gender}. Çıktı formatı: Başlık, Sözler (Verse, Chorus), Müzik Altyapı Tanımı.`;

            try {
                const lyrics = await generateText(prompt, "Sen profesyonel bir müzik prodüktörüsün.");
                
                document.getElementById('music-result').innerHTML = markedParse(lyrics);
                document.getElementById('music-result-area').style.display = 'block';
                
                const blob = new Blob([lyrics], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const dlBtn = document.getElementById('btn-download-music');
                dlBtn.href = url;
                dlBtn.download = `MemetCinar_Project_${Date.now()}.txt`;
                dlBtn.style.display = 'inline-flex';

                speak("Şarkı taslağını hazırladım patron. İşte sözler: " + lyrics.substring(0, 100) + "...");

            } catch(e) {
                systemNotify("HATA", "Müzik üretimi başarısız.");
            } finally {
                btn.innerHTML = 'BESTELE & ÜRET';
                btn.disabled = false;
            }
        }

        // --- HELPERS ---
        async function generateText(prompt, system) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: system }] },
                tools: [{ google_search: {} }]
            };
            const res = await fetch(`${BASE_URL}${TEXT_MODEL}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Veri alınamadı.";
        }

        async function speak(text) {
            if(!text) {
                 isAiSpeaking = false; 
                 safeStartRecognition();
                 return;
            }
            
            // Konuşma başladığı anda mikrofonu kapat
            isAiSpeaking = true;
            if(recognition) recognition.stop();
            updateStatus("KONUŞUYOR (TTS HAZIRLANIYOR)", "cyan");

            // Metni temizle ve kısalt (TTS limiti 300 karakter civarı)
            const clean = text.replace(/<[^>]*>/g, '').substring(0, 300); 
            
            const payload = {
                contents: [{ parts: [{ text: clean }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Fenrir" } } } },
                model: TTS_MODEL
            };

            try {
                const res = await fetch(`${BASE_URL}${TTS_MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                
                if(b64) {
                    playAudio(b64);
                } else {
                    isAiSpeaking = false; // Reset if no audio
                    systemNotify("TTS HATA", "Ses verisi üretilemedi.");
                    safeStartRecognition();
                }
            } catch(e) { 
                console.error("TTS Fail", e); 
                isAiSpeaking = false; 
                safeStartRecognition();
            }
        }

        function playAudio(base64) {
            if(!audioContext) return;
            
            // Düzeltilmiş durum güncellemesi
            updateStatus("KONUŞUYOR (SES ÇIKIŞI)", "cyan");

            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
            const pcm16 = new Int16Array(bytes.buffer);
            
            // Audio Buffer hazırlığı
            const audioBuffer = audioContext.createBuffer(1, pcm16.length, 24000);
            const channelData = audioBuffer.getChannelData(0);
            for (let i = 0; i < pcm16.length; i++) channelData[i] = pcm16[i] / 32768.0;
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            
            // ** DÜZELTME: Konuşma bittikten sonra dinlemeyi yeniden başlat **
            source.onended = () => {
                isAiSpeaking = false;
                if(isSystemActive) {
                    // İşlem bittiğinde uyku moduna geri dön
                    isWakeWordMode = true; 
                    safeStartRecognition();
                }
            };
            
            source.start(0);
        }

        function playSystemSound(type) {
            if (!audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            if (type === 'startup') {
                osc.frequency.setValueAtTime(220, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                osc.start(); osc.stop(audioContext.currentTime + 0.5);
            } else if (type === 'wake') {
                osc.frequency.setValueAtTime(800, audioContext.currentTime);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                osc.start(); osc.stop(audioContext.currentTime + 0.2);
            }
        }

        function systemNotify(title, message) {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = 'notify-toast';
            toast.innerHTML = `
                <i class="fa-solid fa-bell text-cyan-400"></i>
                <div>
                    <div class="font-bold text-sm">${title}</div>
                    <div class="text-xs opacity-80">${message}</div>
                </div>
                <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-white"><i class="fa-solid fa-check"></i></button>
            `;
            area.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function addMessage(html, role) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `msg-bubble ${role === 'user' ? 'msg-user' : 'msg-ai'}`;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showThinking(show) {
            const el = document.getElementById('thinking-el');
            el.style.display = show ? 'flex' : 'none';
            if(show) {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('sys-time').innerText = now.toLocaleTimeString();
            document.getElementById('sys-date').innerText = now.toLocaleDateString();
        }

        window.toggleSettings = () => {
            const el = document.getElementById('settings-panel');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
        
        window.saveSettings = () => {
            wakeWord = document.getElementById('set-wakeword').value.toLowerCase() || "patron";
            toggleSettings();
            systemNotify("AYARLAR", "Uyandırma kelimesi güncellendi.");
        }

        function markedParse(text) {
             // Basit Markdown to HTML çevirisi
             return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

    </script>
</head>
<body>
    <!-- Scanline Overlay -->
    <div class="scanline"></div>

    <!-- Notification Area -->
    <div id="notification-area"></div>

    <!-- START OVERLAY (Permission Gate) -->
    <div id="start-overlay" class="fixed inset-0 bg-black z-50 flex items-center justify-center flex-col transition-opacity duration-500">
        <div class="text-center relative">
            <div class="w-32 h-32 rounded-full border border-cyan-500/30 flex items-center justify-center mb-6 relative animate-pulse">
                <div class="absolute inset-0 border-t-2 border-cyan-400 rounded-full animate-spin"></div>
                <i class="fa-solid fa-power-off text-4xl text-cyan-400"></i>
            </div>
            <h1 class="text-4xl font-bold tracking-widest text-white mb-2 font-['Orbitron']">MEMET ÇINAR</h1>
            <p class="text-cyan-500/60 font-mono mb-8">AI SYSTEM INITIALIZATION // v5.3</p>
            <button onclick="startSystem()" class="px-8 py-3 bg-cyan-900/40 border border-cyan-500 text-cyan-400 hover:bg-cyan-500 hover:text-black transition tracking-widest font-bold rounded clip-path-polygon">
                SİSTEMİ BAŞLAT
            </button>
            <p class="mt-4 text-xs text-gray-600 max-w-md mx-auto">
                Mikrofon izni sadece bir kez istenir. "Hey Patron" özelliği için sistemin açık kalması gerekir.
            </p>
        </div>
    </div>

    <!-- MAIN UI -->
    <div class="flex-1 flex flex-col p-2 md:p-6 gap-4 relative z-10 max-w-7xl mx-auto w-full h-full">
        
        <!-- HEADER HUD -->
        <div class="hud-panel p-4 flex justify-between items-center rounded-t-lg">
            <div class="hud-corner tl"></div> <div class="hud-corner tr"></div>
            
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-cyan-900/20 border border-cyan-500/50 flex items-center justify-center">
                    <i class="fa-solid fa-microchip text-cyan-400"></i>
                </div>
                <div>
                    <h1 class="hud-title text-xl text-white">MEMET ÇINAR</h1>
                    <div class="hud-text text-xs text-cyan-500/70 flex gap-2">
                        <span>ONLINE</span> | <span>CPU: NORMAL</span> | <span id="system-status" class="text-red-400">OFFLINE</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="hidden md:block text-right">
                    <div id="sys-time" class="hud-text text-2xl font-bold text-white leading-none">00:00:00</div>
                    <div id="sys-date" class="hud-text text-xs text-gray-500">01.01.2025</div>
                </div>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-cyan-400 transition"><i class="fa-solid fa-gear fa-xl"></i></button>
            </div>
        </div>

        <!-- MAIN AREA -->
        <div class="flex-1 flex gap-4 overflow-hidden relative">
            
            <!-- LEFT: VISUALIZER / STATUS (Desktop Only) -->
            <div class="hidden md:flex w-64 hud-panel flex-col p-4 rounded-bl-lg">
                 <div class="hud-corner bl"></div>
                 <div class="text-cyan-500 text-sm font-bold mb-4 hud-title">SYSTEM DIAGNOSTICS</div>
                 
                 <!-- Animated Graphic -->
                 <div class="flex-1 flex items-center justify-center relative border border-white/5 bg-black/40 rounded mb-4">
                    <div id="listening-anim" class="listening-ring transition-opacity duration-300 opacity-0"></div>
                    <i class="fa-solid fa-fingerprint text-6xl text-white/10"></i>
                 </div>

                 <!-- Quick Stats -->
                 <div class="space-y-3 font-mono text-xs text-gray-400">
                    <div class="flex justify-between"><span>AUDIO IN:</span> <span class="text-green-400">READY</span></div>
                    <div class="flex justify-between"><span>NETWORK:</span> <span class="text-green-400">SECURE</span></div>
                    <div class="flex justify-between"><span>TTS STATE:</span> <span id="tts-state" class="text-yellow-400">IDLE</span></div>
                 </div>

                 <button onclick="openMusicMaker()" class="mt-auto w-full py-3 border border-pink-500/50 text-pink-400 hover:bg-pink-500/10 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-music"></i> AI STUDIO
                 </button>
            </div>

            <!-- CENTER: CHAT -->
            <div class="flex-1 hud-panel flex flex-col rounded-b-lg md:rounded-b-none relative">
                <div class="hud-corner br"></div>
                <div class="hud-corner bl md:hidden"></div>

                <!-- Chat History -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 chat-scroll">
                    <div class="msg-bubble msg-ai">
                        <div class="font-bold text-cyan-400 text-sm mb-1">SİSTEM</div>
                        Hoş geldin Patron. Tüm sistemler aktif. <br>
                        "Hey Patron" diyerek beni uyandırabilirsin.<br>
                        Deneyebileceğin komutlar:
                        <ul class="list-disc list-inside mt-2 text-sm opacity-80">
                            <li>"İstanbul hava durumu nasıl?"</li>
                            <li>"Dolar kuru ne kadar?"</li>
                            <li>"Süper lig maç skorları"</li>
                            <li>"Yılbaşına ne kadar kaldı?"</li>
                        </ul>
                    </div>
                    
                    <div id="thinking-el" class="hidden items-center gap-3 p-4 text-cyan-500 animate-pulse">
                        <i class="fa-solid fa-circle-notch fa-spin"></i>
                        <span class="hud-text">VERİ İŞLENİYOR...</span>
                    </div>
                </div>

                <!-- Input Bar -->
                <div class="p-4 bg-black/40 border-t border-white/5 flex gap-3 items-center">
                    <button onclick="openMusicMaker()" class="md:hidden text-pink-400 p-2"><i class="fa-solid fa-music"></i></button>
                    <div class="flex-1 relative group">
                        <input id="user-input" type="text" placeholder="Komut girin..." class="w-full bg-slate-900/50 border border-slate-700 text-white p-3 pl-4 rounded-none focus:border-cyan-500 outline-none font-mono transition-colors" onkeydown="if(event.key==='Enter') handleSend()">
                        <div class="absolute bottom-0 left-0 h-[2px] bg-cyan-500 w-0 group-focus-within:w-full transition-all duration-500"></div>
                    </div>
                    <button onclick="handleSend()" class="bg-cyan-600 hover:bg-cyan-500 text-white w-12 h-12 flex items-center justify-center clip-path-polygon transition-all">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-panel" class="hidden absolute top-20 right-4 md:right-20 w-80 bg-slate-900 border border-slate-700 p-5 shadow-2xl z-40 rounded">
        <h3 class="text-white font-bold mb-4 border-b border-gray-700 pb-2">SİSTEM AYARLARI</h3>
        
        <div class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 block mb-1">UYANDIRMA KELİMESİ</label>
                <input id="set-wakeword" type="text" value="patron" class="w-full bg-black border border-gray-600 text-white p-2 text-sm">
            </div>
            
            <div>
                <label class="text-xs text-gray-400 block mb-1">SİSTEM DİLİ</label>
                <select class="w-full bg-black border border-gray-600 text-white p-2 text-sm">
                    <option value="tr">Türkçe (Varsayılan)</option>
                    <option value="en">English</option>
                    <option value="de">Deutsch</option>
                    <option value="jp">日本語</option>
                </select>
            </div>

            <div>
                <label class="text-xs text-gray-400 block mb-1">ARAYÜZ TEMASI</label>
                <div class="flex gap-2">
                    <div class="w-6 h-6 bg-cyan-500 rounded cursor-pointer border-2 border-white"></div>
                    <div class="w-6 h-6 bg-red-500 rounded cursor-pointer opacity-50"></div>
                    <div class="w-6 h-6 bg-green-500 rounded cursor-pointer opacity-50"></div>
                </div>
            </div>
            
            <button onclick="saveSettings()" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white py-2 text-sm mt-2">KAYDET VE KAPAT</button>
        </div>
    </div>

    <!-- MUSIC MAKER MODAL -->
    <div id="music-modal" class="fixed inset-0 z-50 bg-black/90 backdrop-blur flex items-center justify-center hidden">
        <div class="bg-slate-900 border border-pink-500/30 w-full max-w-2xl p-6 rounded-lg shadow-2xl relative overflow-hidden">
            <!-- Background Decoration -->
            <div class="absolute top-0 right-0 p-10 opacity-10 pointer-events-none">
                <i class="fa-solid fa-compact-disc text-9xl text-pink-500 music-disc"></i>
            </div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-pink-500"></i> AI STUDIO
                    </h2>
                    <button onclick="closeMusicMaker()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-xl"></i></button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-pink-300 text-sm mb-1">Müzik Stili</label>
                            <input id="music-style" type="text" placeholder="Örn: Cyberpunk Synthwave, Melankolik Rap..." class="w-full bg-black/50 border border-gray-600 p-3 text-white rounded focus:border-pink-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-pink-300 text-sm mb-1">Şarkının Konusu/Başlığı</label>
                            <input id="music-topic" type="text" placeholder="Örn: Uzayda kaybolan bir astronot..." class="w-full bg-black/50 border border-gray-600 p-3 text-white rounded focus:border-pink-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-pink-300 text-sm mb-1">Vokal Tipi</label>
                            <select id="music-gender" class="w-full bg-black/50 border border-gray-600 p-3 text-white rounded">
                                <option value="Erkek">Erkek Vokal</option>
                                <option value="Kadın">Kadın Vokal</option>
                                <option value="Düet">Düet</option>
                                <option value="Robotik">Robotik/AI</option>
                            </select>
                        </div>
                        
                        <button id="btn-generate-music" onclick="generateMusic()" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white py-4 font-bold rounded shadow-lg transform hover:scale-[1.02] transition">
                            BESTELE & ÜRET
                        </button>
                    </div>

                    <div id="music-result-area" class="hidden flex flex-col h-full">
                        <div class="text-xs text-gray-400 mb-1">SONUÇ (PROJE DOSYASI)</div>
                        <div id="music-result" class="flex-1 bg-black/60 border border-gray-700 p-4 text-xs font-mono text-gray-300 overflow-y-auto max-h-[250px] rounded mb-3"></div>
                        <a id="btn-download-music" href="#" class="hidden text-center border border-green-500 text-green-400 hover:bg-green-500/10 py-2 rounded text-sm transition">
                            <i class="fa-solid fa-download"></i> PROJE DOSYASINI İNDİR (.TXT)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

